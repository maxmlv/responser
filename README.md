# EPAM [OnlineUA] Cloud&DevOps Fundamentals Autumn 2022 | Final Project

### [responser.space](http://responser.space)

## Overview

Responser is an imitation of popular social networks built in Java. The application currently supports the following functions:
- Registration and login
- Creation of post with optional content
- Likes
- Comments with ability to reply

From infrastructure perspective, the application runs on AWS Cloud. The infrastructure itself is created using IaC.
Jenkins is a vital component of the system as it is responsible for creation of infrastructure and application life-cycle based on GitOps practices.

### Technologies Stack:

#### Development

- __Frontend__
  - Thymeleaf
  - Bootstrap
- __Backend__
  - Java
  - Spring Framework
- __Database__
  - MySQL

#### DevOps

- __AWS__
  - VPC
  - EC2
  - RDS
  - S3
  - EFS
  - Route53 (SSL certificates provided by __Let's Encrypt__)
  - Secrets Manager
- __IaC__
  - Terraform
- __CI/CD__
  - Jenkins
- __Configuration Automation__
  - Ansible
  - Bash
- __Containerization__
  - Docker

## Infrastructure

![Infra Diagram](screenshots/infra_diagram.png)

### Terraform

Terraform is responsible for creation of the whole application required infrastructure. 
The code is divided into a set of modules which are dependent on each other using terraform outputs.  

Below you can find a more detailed overview for each module:

#### RDS module

This module creates a RDS instance with MySQL database and all required resources for it 
such as Security Groups and Database Subnet Groups. Outputs contain values needed for database connectivity.

#### S3 module

This module creates a S3 bucket with public-read permissions. 
This bucket will be used as a storage for image files posted by users.

#### EC2 module

This module creates an EC2 instance and Security Group for application. 
This module is implemented twice in order to create Green and Blue instances. 
Outputs contains public IP address of the created instances.

#### Additional configuration

It's important to notice that ansible is dependant of outputs of terraform code. 
Hence, hosts.cfg used in ansible is generated by terraform from a template.

``` HCL
resource "local_file" "hosts_cfg" {
  content = templatefile("${path.module}/templates/hosts.tpl",
    {
      blue = [module.blue.public_ip]
      green = [module.green.public_ip]
    }
  )
  filename = "../ansible/hosts.ini"

  depends_on = [module.blue, module.green]
}
```

## Docker inside Jenkins EC2 instance

In order to keep build pipeline clean and reduce build time, 
builds are running on a custom Docker image built from the latest Jenkins-agent Docker image. 
This image has terraform, ansible, aws-cli and other dependencies pre-installed.

Also, Jenkins Agents have pre-defined environment variables
such as AWS credentials for __aws cli__ ans __Route53__ Hosted
Zone ID.

``` Groovy
agent {
        node {
            label 'jenkins-docker-agent'
        }
}
```


## CI/CD

![CI/CD diagram](screenshots/cicd_diagram.png)

### Maven

Maven is responsible for Build and Test stages. 
After build is performed, the application is tested using unit and integration tests.

### Terraform

__Terraform__ is running __init__ and __plan__ stage first to 
make sure code is ready for the __apply__ stage and build
infrastructure.

### Deployment Strategy State

This stage is set of bash scripts to pull current state of 
__responser.space__ A record on __Route53__ Hosted Zone.
(It can be weather "blue" or "green")

deploy_state.sh pulls information from AWS using aws cli. 
Then the fetched values are written into a file which represents current state of the application. 
This file will be used in the next stages.

### Ansible PK and Vars retrieval

This build step consists of two stages: 

1. Retrieval of private key from AWS Secrets Manager
2. Terraform output variables are written into vars.yaml, so they can be used consistently during Ansible steps.

### Ansible EFS Mount

This stage runs an ansible playbook, which mounts EFS volume containing SSL certificate to Blue and Green EC2s.

### Ansible Web

The following stage sets up NGINX reverse proxy which also enforces HTTPS, 
ensures Java installation and create necessary directories for the application.

### Ansible Deployment

This stages ensurers that all environment variables are in place, 
uploads recently built jar file and starts the responser.

### Post-Deployment Traffic Switch

After all stages ran successfully, user traffic can be switched. 
This is done by tag update to indicate current state and update in A record with the new IP.